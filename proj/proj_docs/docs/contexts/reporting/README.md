# README.md

Brief: Overview and implementation manual for Reporting context. Scope, entities, business rules, integration points.

# Reporting Bounded Context

## Purpose

This bounded context handles attendance report generation and export. It allows lecturers and admins to generate, view, and export attendance reports for sessions.

## Scope

### What This Context Handles
- Attendance report generation
- Report export (CSV, Excel formats)
- Report metadata storage
- Report access control (lecturer sees own reports, admin sees all)
- Attendance statistics calculation

### What This Context Does NOT Handle
- Attendance recording → handled by Attendance Recording Context
- Session creation → handled by Session Management Context
- User authentication → handled by User Management Context
- Email notifications → handled by Email Notification Context

## Core Entities

### Report
- **Primary entity** representing a generated attendance report
- Attributes:
  - `report_id` (Primary Key, Integer, Auto-increment) - Unique identifier
  - `session_id` (Foreign Key → Session.session_id, NOT NULL) - Session this report is for
  - `generated_by` (Foreign Key → User.user_id, NOT NULL) - User who generated the report
  - `generated_date` (DateTime, NOT NULL, Auto-set) - When report was generated
  - `file_path` (String, **NULLABLE**) - Path to exported file (if exported)
    - **NULL if report not exported** (only viewed online)
    - **Set when exported** to CSV or Excel
  - `file_type` (Enum, **NULLABLE**) - Export format: `csv` or `excel`
    - **NULL if not exported**
    - **Set when exported**

**Important Notes:**
- Multiple reports can be generated for the same session (historical snapshots)
- `file_path` and `file_type` are nullable (not all reports are exported)
- Reports can be viewed online without exporting
- Exporting creates a file and stores metadata

## Business Rules

### Report Generation Workflow

When a user generates a report:

1. **Authorization Check**:
   - **Lecturer**: Can only generate reports for own sessions (where `session.lecturer_id = lecturer_id`)
   - **Admin**: Can generate reports for any session
   - **Student**: Cannot generate reports

2. **Data Collection**:
   - Get session details (course, date, time, program, stream)
   - Get list of all eligible students (by program/stream)
   - For each eligible student:
     - Check if attendance exists
     - Get attendance details (time, location, status, is_within_radius)
     - Mark as "Present", "Late", or "Absent"

3. **Report Metadata Creation**:
   - Create Report record with session_id and generated_by
   - Set generated_date to current timestamp
   - Initially file_path and file_type are NULL (view only)

4. **Report Display**:
   - Show table with columns:
     - Student ID (e.g., BCS/234344)
     - Student Name
     - Attendance Status (Present/Late/Absent)
     - Time Recorded (if attended)
     - Within Radius? (Yes/No, if attended)

5. **Optional Export**:
   - User can export to CSV or Excel
   - Generate file in designated export directory
   - Update Report record with file_path and file_type
   - Return download link

### Attendance Status Classification

For each eligible student in the report:

- **Present**: 
  - Attendance exists
  - `status = "present"`
  - `is_within_radius = True`
  - Marked within session time window

- **Late**: 
  - Attendance exists
  - `status = "late"` OR `is_within_radius = False`
  - Marked within or near session time window but with issues

- **Absent**: 
  - No attendance record exists for this student and session

**Important Notes:**
- "Absent" is inferred (no attendance record)
- "Late" can be due to time (marked late) or location (outside 30m)
- All eligible students appear in report (even if absent)

### Report Access Control

- **Lecturer**: 
  - Can view/generate reports for own sessions only
  - Cannot view other lecturers' reports
  
- **Admin**: 
  - Can view/generate reports for all sessions
  - Can view reports generated by others
  
- **Student**: 
  - Cannot generate reports
  - Cannot view reports (no dashboard access)

### Export File Management

**File Naming Convention**:
```
session_{session_id}_{timestamp}.{csv|xlsx}
```

Example: `session_456_20251019143022.csv`

**Storage Location**:
```
/media/reports/
  2025/
    10/
      session_456_20251019143022.csv
      session_456_20251019143022.xlsx
```

**File Retention**:
- Files stored indefinitely (or per institution policy)
- Admin can manually delete old reports
- Database records remain even if files are deleted

## Validation Rules

### Report Generation Authorization
- User must be authenticated
- User must have permission (Lecturer for own sessions, Admin for all)
- Session must exist

### Export Format Validation
- `file_type` must be `csv` or `excel`
- Cannot export if session has no eligible students (edge case)

### File Path Validation
- Must be valid file system path
- Must be within designated export directory
- Cannot overwrite existing files (use timestamp in name)

## Database Constraints

### Report Table
```sql
CREATE TABLE reports (
  report_id SERIAL PRIMARY KEY,
  session_id INTEGER NOT NULL REFERENCES sessions(session_id) ON DELETE CASCADE,
  generated_by INTEGER NOT NULL REFERENCES users(user_id),
  generated_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  file_path VARCHAR(500),  -- NULLABLE
  file_type VARCHAR(10) CHECK (file_type IN ('csv', 'excel')),  -- NULLABLE
  
  CONSTRAINT file_type_requires_path CHECK (
    (file_type IS NULL AND file_path IS NULL) OR 
    (file_type IS NOT NULL AND file_path IS NOT NULL)
  )
);

CREATE INDEX idx_reports_session_id ON reports(session_id);
CREATE INDEX idx_reports_generated_by ON reports(generated_by);
CREATE INDEX idx_reports_generated_date ON reports(generated_date);
```

**Important Constraint Notes:**
- `ON DELETE CASCADE`: Deleting session deletes all its reports
- `file_path` and `file_type` are both nullable
- CHECK constraint ensures `file_type` and `file_path` are either both NULL or both NOT NULL
- Multiple reports can exist for same session (historical snapshots)

## Report Content Structure

### CSV Format Example
```csv
Student ID,Student Name,Email,Program,Stream,Status,Time Recorded,Within Radius,Latitude,Longitude
BCS/234344,John Doe,john@example.com,Computer Science,Stream A,Present,2025-10-19 14:30:22,Yes,-1.286389,36.817223
BCS/234345,Jane Smith,jane@example.com,Computer Science,Stream A,Absent,,,,,
BCS/234346,Bob Johnson,bob@example.com,Computer Science,Stream A,Late,2025-10-19 14:45:10,No,-1.287000,36.818000
```

### Excel Format
Same columns as CSV but with:
- Header row in bold
- Status column color-coded (Green = Present, Yellow = Late, Red = Absent)
- Conditional formatting for "Within Radius" column

### Report Header Information
Every report includes:
- Session ID
- Course Name and Code
- Program Name (and Stream if applicable)
- Session Date and Time
- Lecturer Name
- Report Generated Date
- Report Generated By (user name)
- Total Students: X
- Present: Y (Z%)
- Late: A (B%)
- Absent: C (D%)

## Django Implementation Structure

```
reporting/
├── models.py           # Report model
├── repositories.py     # ReportRepository
├── services.py         # ReportService, ExportService (CSV/Excel generation)
├── handlers.py         # GenerateReportHandler, ExportReportHandler
├── views.py           # API endpoints
├── serializers.py     # Request/response serialization
├── validators.py      # Authorization, format validation
├── permissions.py     # IsLecturerOrAdmin, IsReportOwner
├── urls.py            # URL routing
├── exporters.py       # CSVExporter, ExcelExporter classes
├── tests/             # Unit and integration tests
└── migrations/        # Database migrations
```

## Integration Points

### Outbound Dependencies (What We Call)
- **Session Management Context**: 
  - Get session details (course, program, stream, date, time, lecturer)
  
- **User Management Context**: 
  - Get eligible students list (by program/stream)
  - Get student details (student_id, name, email)
  - Get lecturer name
  
- **Attendance Recording Context**: 
  - Query attendance records for session
  - Get attendance details (time, status, location, is_within_radius)
  
- **Infrastructure**: 
  - File system for export storage
  - CSV library (Python csv module)
  - Excel library (openpyxl or xlsxwriter)

### Inbound Dependencies (Who Calls Us)
- **Lecturers/Admins** (via UI/API): 
  - Request report generation
  - Request report export
  - Download exported files

## Side Effects

When a report is generated:
1. Report metadata saved to database
2. No file created initially (view only)

When a report is exported:
1. File generated in export directory
2. Report record updated with file_path and file_type
3. File path returned to user for download

## Files in This Context

### 1. `README.md` (this file)
Overview of the bounded context

### 2. `models_guide.md`
Step-by-step guide for creating Django models:
- Report model
- Nullable file_path and file_type
- CHECK constraint linking them

### 3. `repositories_guide.md`
Guide for creating repository layer:
- ReportRepository
- Query reports by session, by user, by date range
- Update report with export details

### 4. `services_guide.md`
Guide for creating domain services:
- ReportService (collect data, calculate statistics)
- ExportService (orchestrate CSV/Excel generation)
- AttendanceAggregator (classify students as Present/Late/Absent)

### 5. `exporters_guide.md`
Guide for creating export classes:
- CSVExporter (generate CSV files)
- ExcelExporter (generate Excel files with formatting)
- File naming and storage

### 6. `handlers_guide.md`
Guide for creating application layer handlers:
- GenerateReportHandler (collect data, create Report record)
- ExportReportHandler (generate file, update Report record)
- DownloadReportHandler (serve file)

### 7. `views_guide.md`
Guide for creating API endpoints:
- GET /api/v1/sessions/{id}/report/ (view report online)
- POST /api/v1/sessions/{id}/report/export/ (export to CSV/Excel)
- GET /api/v1/reports/{id}/download/ (download exported file)
- GET /api/v1/reports/ (list all reports - admin only)

### 8. `permissions_guide.md`
Guide for implementing access control:
- IsLecturerOrAdmin permission
- IsReportOwnerOrAdmin permission
- Session ownership check (lecturer can only report own sessions)

### 9. `testing_guide.md`
Guide for writing tests:
- Test report generation with all/some/no attendance
- Test Present/Late/Absent classification
- Test CSV export
- Test Excel export
- Test authorization (lecturer vs admin)
- Test file naming and storage

## Implementation Order

1. **Models** (`models_guide.md`) - Report model
2. **Repositories** (`repositories_guide.md`) - Data access
3. **Services** (`services_guide.md`) - ReportService, AttendanceAggregator
4. **Exporters** (`exporters_guide.md`) - CSVExporter, ExcelExporter
5. **Handlers** (`handlers_guide.md`) - GenerateReportHandler, ExportReportHandler
6. **Views** (`views_guide.md`) - API endpoints
7. **Permissions** (`permissions_guide.md`) - Access control
8. **Tests** (`testing_guide.md`) - Comprehensive testing

## Next Steps

After reading this overview:
1. Understand report vs export (metadata vs file)
2. Verify nullable file_path and file_type
3. Confirm Present/Late/Absent classification logic
4. Review access control (lecturer owns reports for own sessions)
5. Understand CSV/Excel export formats
6. Proceed to detailed guide files

---

**Status**: 📝 Overview Complete - Ready for detailed guide creation
